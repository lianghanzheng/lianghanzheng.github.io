<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="RRZ&#39;s Blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="RRZ&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ReRoozen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>RRZ's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">RRZ's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/LLVMDeveloperMeeting/2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/LLVMDeveloperMeeting/2023/" class="post-title-link" itemprop="url">2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-12-01 22:38:33 / 修改时间：23:06:26" itemprop="dateCreated datePublished" datetime="2023-12-01T22:38:33+08:00">2023-12-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Extensible-and-Composable-Dataflow-Analysis-in-MLIR"><a href="#Extensible-and-Composable-Dataflow-Analysis-in-MLIR" class="headerlink" title="Extensible and Composable Dataflow Analysis in MLIR"></a>Extensible and Composable Dataflow Analysis in MLIR</h2><h2 id="Using-MLIR-to-Optimize-Basic-Linear-Algebraic-Subprograms"><a href="#Using-MLIR-to-Optimize-Basic-Linear-Algebraic-Subprograms" class="headerlink" title="Using MLIR to Optimize Basic Linear Algebraic Subprograms"></a>Using MLIR to Optimize Basic Linear Algebraic Subprograms</h2><h2 id="MachineScheduler-fine-grain-resource-allocation-using-resource-intervals"><a href="#MachineScheduler-fine-grain-resource-allocation-using-resource-intervals" class="headerlink" title="MachineScheduler - fine grain resource allocation using resource intervals"></a>MachineScheduler - fine grain resource allocation using resource intervals</h2><h2 id="Practical-Global-Merge-Function-with-ThinLTO"><a href="#Practical-Global-Merge-Function-with-ThinLTO" class="headerlink" title="Practical Global Merge Function with ThinLTO"></a>Practical Global Merge Function with ThinLTO</h2><h2 id="mlir-meminfo-A-Memory-Model-for-MLIR"><a href="#mlir-meminfo-A-Memory-Model-for-MLIR" class="headerlink" title="mlir-meminfo : A Memory Model for MLIR"></a>mlir-meminfo : A Memory Model for MLIR</h2><h2 id="A-whirlwind-tour-of-the-LLVM-optimizer"><a href="#A-whirlwind-tour-of-the-LLVM-optimizer" class="headerlink" title="A whirlwind tour of the LLVM optimizer"></a>A whirlwind tour of the LLVM optimizer</h2><h2 id="Developing-BOLT-pass"><a href="#Developing-BOLT-pass" class="headerlink" title="Developing BOLT pass"></a>Developing BOLT pass</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/LLVMDeveloperMeeting/2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/LLVMDeveloperMeeting/2022/" class="post-title-link" itemprop="url">2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-01 22:38:30" itemprop="dateCreated datePublished" datetime="2023-12-01T22:38:30+08:00">2023-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-07 16:47:28" itemprop="dateModified" datetime="2023-12-07T16:47:28+08:00">2023-12-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Precise-Polyhedral-Analyses-For-MLIR-using-the-FPL-Presburger-Library"><a href="#Precise-Polyhedral-Analyses-For-MLIR-using-the-FPL-Presburger-Library" class="headerlink" title="Precise Polyhedral Analyses For MLIR using the FPL Presburger Library"></a>Precise Polyhedral Analyses For MLIR using the FPL Presburger Library</h2><h2 id="How-to-write-a-new-compiler-driver-The-LLVM-Flang-perspective"><a href="#How-to-write-a-new-compiler-driver-The-LLVM-Flang-perspective" class="headerlink" title="How to write a new compiler driver? The LLVM Flang perspective"></a>How to write a new compiler driver? The LLVM Flang perspective</h2><h2 id="Paths-towards-unifying-LLVM-and-MLIR"><a href="#Paths-towards-unifying-LLVM-and-MLIR" class="headerlink" title="Paths towards unifying LLVM and MLIR"></a>Paths towards unifying LLVM and MLIR</h2><h2 id="Heterogeneous-Debug-Metadata-in-LLVM"><a href="#Heterogeneous-Debug-Metadata-in-LLVM" class="headerlink" title="Heterogeneous Debug Metadata in LLVM"></a>Heterogeneous Debug Metadata in LLVM</h2><h2 id="What-does-it-take-to-run-LLVM-Buildbots"><a href="#What-does-it-take-to-run-LLVM-Buildbots" class="headerlink" title="What does it take to run LLVM Buildbots?"></a>What does it take to run LLVM Buildbots?</h2><h2 id="VAST-MLIR-for-program-analysis-of-C-C"><a href="#VAST-MLIR-for-program-analysis-of-C-C" class="headerlink" title="VAST: MLIR for program analysis of C&#x2F;C++"></a>VAST: MLIR for program analysis of C&#x2F;C++</h2><h2 id="SPIR-V-Backend-in-LLVM-Upstream-and-Beyond"><a href="#SPIR-V-Backend-in-LLVM-Upstream-and-Beyond" class="headerlink" title="SPIR-V Backend in LLVM: Upstream and Beyond"></a>SPIR-V Backend in LLVM: Upstream and Beyond</h2><p>@Intel</p>
<ul>
<li>SPIR-V LLVM translator is a production-ready bi-direction “bridge” between LLVM IR and SPIR-V.</li>
<li>SPIR-V is much closer to LLVM IR than to MIR</li>
<li>Instruction Selection<ul>
<li>Relying on TabelGen as much as possible</li>
<li>Type information folding</li>
<li>No “real” registers in SPIR-V</li>
</ul>
</li>
</ul>
<h2 id="llvm-dialects-bringing-dialects-to-the-LLVM-IR-substrate"><a href="#llvm-dialects-bringing-dialects-to-the-LLVM-IR-substrate" class="headerlink" title="llvm-dialects: bringing dialects to the LLVM IR substrate"></a>llvm-dialects: bringing dialects to the LLVM IR substrate</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/LLVMDeveloperMeeting/2021/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/LLVMDeveloperMeeting/2021/" class="post-title-link" itemprop="url">2021</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-01 22:38:25" itemprop="dateCreated datePublished" datetime="2023-12-01T22:38:25+08:00">2023-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-07 16:27:38" itemprop="dateModified" datetime="2023-12-07T16:27:38+08:00">2023-12-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="FPL-A-Presburger-Library-in-MLIR"><a href="#FPL-A-Presburger-Library-in-MLIR" class="headerlink" title="FPL: A Presburger Library in MLIR"></a>FPL: A Presburger Library in MLIR</h2><h2 id="Enabling-Interactive-C-with-Clang"><a href="#Enabling-Interactive-C-with-Clang" class="headerlink" title="Enabling Interactive C++ with Clang"></a>Enabling Interactive C++ with Clang</h2><h2 id="Deconstructing-the-Myth-“Only-real-coders-contribute-to-LLVM-”-Takeaways"><a href="#Deconstructing-the-Myth-“Only-real-coders-contribute-to-LLVM-”-Takeaways" class="headerlink" title="Deconstructing the Myth: “Only real coders contribute to LLVM!”? - Takeaways"></a>Deconstructing the Myth: “Only real coders contribute to LLVM!”? - Takeaways</h2><h2 id="Extending-LLVM’s-optimization-repertoire-to-build-a-highly-optimizing-compiler"><a href="#Extending-LLVM’s-optimization-repertoire-to-build-a-highly-optimizing-compiler" class="headerlink" title="Extending LLVM’s optimization repertoire to build a highly optimizing compiler"></a>Extending LLVM’s optimization repertoire to build a highly optimizing compiler</h2><h2 id="SPIR-V-support-in-LLVM-and-Clang"><a href="#SPIR-V-support-in-LLVM-and-Clang" class="headerlink" title="SPIR-V support in LLVM and Clang"></a>SPIR-V support in LLVM and Clang</h2><p>@Khronos group</p>
<p>Similar to LLVM IR, BUT DIFFERENT!</p>
<ul>
<li>Core specifications, defined by the Khronos SPIR-V group</li>
<li>Environment specifications, defined by the client API<ul>
<li>Can apply more restrictions to core specifications</li>
</ul>
</li>
<li>Extended instruction sets<ul>
<li>Extra instructions a client API can define</li>
</ul>
</li>
</ul>
<h3 id="Current-state"><a href="#Current-state" class="headerlink" title="Current state"></a>Current state</h3><ul>
<li><code>llvm-spirv text.bc -o test.spv</code></li>
<li><code>spirv-link</code>, <code>spirv-opt</code>, <code>spirv-val</code> from <a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/SPIRV-Tools">https://github.com/KhronosGroup/SPIRV-Tools</a><br><br><code>spirv-link -o app.spv test.spv</code></li>
</ul>
<h2 id="Architecting-out-of-tree-LLVM-projects-using-cmake"><a href="#Architecting-out-of-tree-LLVM-projects-using-cmake" class="headerlink" title="Architecting out-of-tree LLVM projects using cmake"></a>Architecting out-of-tree LLVM projects using cmake</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/LLVMDeveloperMeeting/2020/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/LLVMDeveloperMeeting/2020/" class="post-title-link" itemprop="url">2020</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-01 22:38:22" itemprop="dateCreated datePublished" datetime="2023-12-01T22:38:22+08:00">2023-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-06 12:53:35" itemprop="dateModified" datetime="2023-12-06T12:53:35+08:00">2023-12-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Code-Size-Compiler-Optimizations-and-Techniques"><a href="#Code-Size-Compiler-Optimizations-and-Techniques" class="headerlink" title="Code Size Compiler Optimizations and Techniques"></a>Code Size Compiler Optimizations and Techniques</h2><h2 id="CIL-Common-MLIR-Dialect-for-C-C-and-Fortran"><a href="#CIL-Common-MLIR-Dialect-for-C-C-and-Fortran" class="headerlink" title="CIL : Common MLIR Dialect for C&#x2F;C++ and Fortran"></a>CIL : Common MLIR Dialect for C&#x2F;C++ and Fortran</h2><h2 id="Everything-I-know-about-debugging-LLVM"><a href="#Everything-I-know-about-debugging-LLVM" class="headerlink" title="Everything I know about debugging LLVM"></a>Everything I know about debugging LLVM</h2><h2 id="LLVM-in-a-Bare-Metal-Environment"><a href="#LLVM-in-a-Bare-Metal-Environment" class="headerlink" title="LLVM in a Bare Metal Environment"></a>LLVM in a Bare Metal Environment</h2><h2 id="Understanding-Changes-made-by-a-Pass-in-the-Opt-Pipeline"><a href="#Understanding-Changes-made-by-a-Pass-in-the-Opt-Pipeline" class="headerlink" title="Understanding Changes made by a Pass in the Opt Pipeline"></a>Understanding Changes made by a Pass in the Opt Pipeline</h2><h2 id="MLIR-Tutorial"><a href="#MLIR-Tutorial" class="headerlink" title="MLIR Tutorial"></a>MLIR Tutorial</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/LLVMDeveloperMeeting/2019/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/LLVMDeveloperMeeting/2019/" class="post-title-link" itemprop="url">2019</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-01 22:38:10" itemprop="dateCreated datePublished" datetime="2023-12-01T22:38:10+08:00">2023-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-07 15:47:40" itemprop="dateModified" datetime="2023-12-07T15:47:40+08:00">2023-12-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MLIR-Multi-Level-Intermediate-Representation-for-Compiler-Infrastructure"><a href="#MLIR-Multi-Level-Intermediate-Representation-for-Compiler-Infrastructure" class="headerlink" title="MLIR: Multi-Level Intermediate Representation for Compiler Infrastructure"></a>MLIR: Multi-Level Intermediate Representation for Compiler Infrastructure</h2><h2 id="Handling-massive-concurrency-Development-of-a-programming-model-for-GPU-and-CPU"><a href="#Handling-massive-concurrency-Development-of-a-programming-model-for-GPU-and-CPU" class="headerlink" title="Handling massive concurrency: Development of a programming model for GPU and CPU"></a>Handling massive concurrency: Development of a programming model for GPU and CPU</h2><h2 id="SYCL-compiler-zero-cost-abstraction-and-type-safety-for-heterogeneous-computing"><a href="#SYCL-compiler-zero-cost-abstraction-and-type-safety-for-heterogeneous-computing" class="headerlink" title="SYCL compiler: zero-cost abstraction and type safety for heterogeneous computing"></a>SYCL compiler: zero-cost abstraction and type safety for heterogeneous computing</h2><h2 id="Loop-Fusion-Loop-Distribution-and-their-Place-in-the-Loop-Optimization-Pipeline"><a href="#Loop-Fusion-Loop-Distribution-and-their-Place-in-the-Loop-Optimization-Pipeline" class="headerlink" title="Loop Fusion, Loop Distribution and their Place in the Loop Optimization Pipeline"></a>Loop Fusion, Loop Distribution and their Place in the Loop Optimization Pipeline</h2><h2 id="Tutorial-Building-a-Compiler-with-MLIR"><a href="#Tutorial-Building-a-Compiler-with-MLIR" class="headerlink" title="Tutorial: Building a Compiler with MLIR"></a>Tutorial: Building a Compiler with MLIR</h2><h2 id="Building-an-LLVM-based-tool-lessons-learned"><a href="#Building-an-LLVM-based-tool-lessons-learned" class="headerlink" title="Building an LLVM-based tool: lessons learned"></a>Building an LLVM-based tool: lessons learned</h2><h2 id="LLVM-IR-Tutorial-Phis-GEPs-and-other-things-oh-my"><a href="#LLVM-IR-Tutorial-Phis-GEPs-and-other-things-oh-my" class="headerlink" title="LLVM IR Tutorial - Phis, GEPs and other things, oh my!"></a>LLVM IR Tutorial - Phis, GEPs and other things, oh my!</h2><p>@Intel</p>
<p>LLVM IR</p>
<ul>
<li>RISC-like</li>
</ul>
<h3 id="Target-info"><a href="#Target-info" class="headerlink" title="Target info"></a>Target info</h3><figure class="highlight llvm"><figcaption><span>IR</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target</span> <span class="keyword">datalayout</span> <span class="operator">=</span> </span><br><span class="line">  <span class="string">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">triple</span> <span class="operator">=</span> <span class="string">&quot;x86_64-unknown-linux-gnu&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Data layout: “little endian-ELF mangling-ABI alignment of i64-?-Native interger widths-?”</li>
<li>Target: “Architecture-vendor-system-ABI”</li>
</ul>
<h3 id="Baisc-program"><a href="#Baisc-program" class="headerlink" title="Baisc program"></a>Baisc program</h3><ul>
<li>Types everywhere<ul>
<li>NO implicit conversions</li>
<li><code>opt -verify input.ll</code> 用来检查LLVM IR中类型是否正确</li>
</ul>
</li>
<li>Instructions have many variants</li>
</ul>
<h4 id="CFG"><a href="#CFG" class="headerlink" title="CFG"></a>CFG</h4><ul>
<li>因分支指令产生<ul>
<li><code>br</code></li>
<li><code>ret</code></li>
</ul>
</li>
<li>每个基本块都由名字<ul>
<li>不一定是显式的，如 <code>%0</code> 也能作为名字，且变量不能重复使用这个名字</li>
</ul>
</li>
</ul>
<p>打印一个CFG：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Don&#x27;t include instructions per block</span></span><br><span class="line">opt -analysis -dot-cfg-only input.ll</span><br><span class="line"><span class="comment"># Include instrcutions</span></span><br><span class="line">opt -analysis -dot-cfg input.ll</span><br></pre></td></tr></table></figure>

<h5 id="一个for循环"><a href="#一个for循环" class="headerlink" title="一个for循环"></a>一个for循环</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define i32 @foo(i32 %val)&#123;</span><br><span class="line">entry:</span><br><span class="line">  ...</span><br><span class="line">check_for_condition:</span><br><span class="line">  ...</span><br><span class="line">for body:</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>变量：</p>
<figure class="highlight llvm"><figcaption><span>IR</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%i.addr</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span></span><br><span class="line"><span class="keyword">store</span> <span class="type">i32</span> <span class="number">2</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%i.addr</span></span><br></pre></td></tr></table></figure>

<p>数组：</p>
<figure class="highlight llvm"><figcaption><span>IR</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%array</span> <span class="operator">=</span> <span class="keyword">global</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i32</span>]</span><br><span class="line">// get element pointer instruction</span><br><span class="line"><span class="variable">%new_ptr</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%array</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的指针是i32类型。</p>
</blockquote>
<h4 id="GEP操作"><a href="#GEP操作" class="headerlink" title="GEP操作"></a>GEP操作</h4><figure class="highlight llvm"><figcaption><span>IR</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">@a_gv</span> <span class="operator">=</span> <span class="keyword">global</span> [<span class="number">6</span> <span class="keyword">x</span> <span class="type">i8</span>] zeroinitilizer</span><br><span class="line"><span class="variable">%new_ptr</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> [<span class="number">6</span> <span class="keyword">x</span> <span class="number">18</span>]<span class="punctuation">,</span> [<span class="number">6</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@a_gv</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">1</span></span><br><span class="line"><span class="variable">%elem_pt</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> [<span class="number">6</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">6</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@a_gv</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>GEP NEVER load from memory.</p>
<blockquote>
<p>这里的指针是一个数组类型。</p>
</blockquote>
<p>两者之间的区别是，最后的偏移量每个单位的距离由基本类型执行，第一个 <code>new_ptr</code> 相当于 <code>array[1]</code>，第二个 <code>new_ptr</code> 相当于 <code>a_gv[7]</code>。</p>
<p><code>elem_pt</code> 从 <code>@a_gv</code> 的0号 <code>[6 x i8]</code> 的分组中取出0号元素。</p>
<h4 id="Aggregate-type"><a href="#Aggregate-type" class="headerlink" title="Aggregate type"></a>Aggregate type</h4><figure class="highlight llvm"><figcaption><span>IR</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%MyStruct</span> <span class="operator">=</span> <span class="keyword">type</span> &lt;&#123; <span class="type">i8</span><span class="punctuation">,</span> <span class="type">i32</span><span class="punctuation">,</span> [<span class="number">3</span> <span class="keyword">x</span> <span class="type">i32</span>] &#125;&gt;</span><br><span class="line"><span class="title">@a_gv</span> <span class="operator">=</span> <span class="keyword">global</span> <span class="variable">%MyStruct</span> &#123; <span class="type">i8</span> <span class="number">99</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">17</span><span class="punctuation">,</span> [<span class="type">i32</span> <span class="number">1</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">2</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">3</span>] &#125;</span><br><span class="line"><span class="variable">%new_ptr</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> <span class="variable">%MyStruct</span>*<span class="punctuation">,</span> <span class="variable">%MyStruct</span>* a_gv<span class="punctuation">,</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">2</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h4><ul>
<li>使用 <code>@</code> 开始而不是 <code>%</code></li>
<li>global keyword<ul>
<li><code>@gv = global i8 42</code></li>
<li><code>@gv = constant i8 42</code></li>
</ul>
</li>
</ul>
<h2 id="Hot-Cold-Splitting-Optimization-Pass-In-LLVM"><a href="#Hot-Cold-Splitting-Optimization-Pass-In-LLVM" class="headerlink" title="Hot Cold Splitting Optimization Pass In LLVM"></a>Hot Cold Splitting Optimization Pass In LLVM</h2><h2 id="Writing-Loop-Optimizations-in-LLVM"><a href="#Writing-Loop-Optimizations-in-LLVM" class="headerlink" title="Writing Loop Optimizations in LLVM"></a>Writing Loop Optimizations in LLVM</h2><p>@IBM</p>
<h3 id="Terms"><a href="#Terms" class="headerlink" title="Terms"></a>Terms</h3><p><a target="_blank" rel="noopener" href="https://llvm.org/docs/LoopTerminology.html">Loop representation</a>:</p>
<ul>
<li>Preheader: A single edge to the header of the loop from outside of the loop</li>
<li>Header: Single entry point to the loop that dominates all other blocks in the loop</li>
<li>Exiting block: The block within the loop that has successors outside of the loop; if multiple blocks have such successors, this is NULL</li>
<li>Latch: Block that contains the branch back to the loop header</li>
<li>Exit block: The successor block of this loop.</li>
</ul>
<h4 id="Loop-closed-SSA-form"><a href="#Loop-closed-SSA-form" class="headerlink" title="Loop closed SSA form"></a>Loop closed SSA form</h4><p>循环中所有的使用的变量都是在循环内部定义的，这使得phi函数只能在循环的出口处被定义。</p>
<ul>
<li><code>llvm::formLCSSA</code></li>
</ul>
<h3 id="Rotated-Loops"><a href="#Rotated-Loops" class="headerlink" title="Rotated Loops"></a>Rotated Loops</h3><ul>
<li>Covert a loop into a <code>do/while</code> style loop</li>
<li>Canonicalize loop latch to have a single predecessor</li>
<li>When the compiler cannot prove loop body will excute &gt;&#x3D;1, insert a guard</li>
<li>It also inserts a loop epilogue, that will be excuted once after the body is finished executing</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> A[<span class="number">100</span>];</span><br><span class="line"><span class="type">int</span> B[<span class="number">100</span>];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">example</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i)</span><br><span class="line">    A[i] = i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Loop-pipeline"><a href="#Loop-pipeline" class="headerlink" title="Loop pipeline"></a>Loop pipeline</h3><ul>
<li>Pipeline builder<ul>
<li>Passes enabled by switch (UnrollAndJam)</li>
<li>Added passes, but do nothing bu default (LoopVectorize, LoopUnroll)</li>
<li>Passes added in EP callbacks (Polly)</li>
<li>Passes never added by pass builder</li>
</ul>
</li>
<li>Transformation order follows pass pipeline<ul>
<li>Eixpoint within <code>LoopPassManager</code> using <code>Updater</code></li>
</ul>
</li>
<li>Non-loop passes in-between</li>
<li>Some passes are <code>FunctionPasses</code></li>
</ul>
<h4 id="Loop-pass-v-s-function-pass"><a href="#Loop-pass-v-s-function-pass" class="headerlink" title="Loop pass v.s. function pass"></a>Loop pass v.s. function pass</h4><p>Consider a FunctionPass first:</p>
<ul>
<li>Better maintained</li>
<li>No LoopPassManager needed<ul>
<li>May require adding function analyses by proxy</li>
</ul>
</li>
<li>No requirement to preserve DominatorTree, LoopAnalysis, LoopSimplify, LCSSA</li>
<li>Control over loop processing order &#x2F; reprocessing behaviour</li>
</ul>
<p>Reasons to write a LoopPass:</p>
<ul>
<li>Apply multiple passes on same loop before processing nest<ul>
<li>i.a. Improved locality</li>
</ul>
</li>
<li>Share reprocessing behaviour with other loop passes</li>
<li>Add pass at the Loop EP Callbacks</li>
<li>Analysis used by other loop passes</li>
</ul>
<h3 id="Demo-Basic-loop-optimization-pass-using-new-pass-manager"><a href="#Demo-Basic-loop-optimization-pass-using-new-pass-manager" class="headerlink" title="Demo: Basic loop optimization pass using new pass manager"></a>Demo: Basic loop optimization pass using new pass manager</h3><h4 id="Step1-Basic-loop-optimization-template"><a href="#Step1-Basic-loop-optimization-template" class="headerlink" title="Step1: Basic loop optimization template"></a><a target="_blank" rel="noopener" href="https://github.com/kitbarton/llvm-project/pull/1">Step1: Basic loop optimization template</a></h4><p>进入网页点开Files changed</p>
<ul>
<li><code>LoopOptTutorial.h</code> 和 <code>LoopOptTutorial.cpp</code> 共同创建了一个编译遍<br><br>目前这个编译遍只是打印了哪些循环被传入了这个pass</li>
<li>对 <code>LoopPassBuilder.cpp</code>、<code>PassRegistry.def</code> 的修改将这个新编写的pass在管理器中注册</li>
<li>对 <code>CMakeLists.txt</code> 的修改让这个Pass被添加进项目中</li>
<li><code>simple.ll</code> 和 <code>loop_nest.ll</code> 是测试样例</li>
</ul>
<h4 id="Step2-Select-Filter-candidate-loops"><a href="#Step2-Select-Filter-candidate-loops" class="headerlink" title="Step2: Select&#x2F;Filter candidate loops"></a><a target="_blank" rel="noopener" href="https://github.com/kitbarton/llvm-project/pull/2">Step2: Select&#x2F;Filter candidate loops</a></h4><ul>
<li>在Pass中增加了对Loop的检查，是否能够进行优化</li>
</ul>
<h4 id="Step3-Add-code-to-split-a-candidate-loop"><a href="#Step3-Add-code-to-split-a-candidate-loop" class="headerlink" title="Step3: Add code to split a candidate loop"></a><a target="_blank" rel="noopener" href="https://github.com/kitbarton/llvm-project/pull/3">Step3: Add code to split a candidate loop</a></h4><p>比较重要的成员函数：</p>
<ul>
<li><code>splitLoopInHalf</code>：对满足条件的循环进行分裂</li>
<li><code>cloneLoop</code>：复制一个循环</li>
<li><code>computeSplitPoint</code>：计算分割点</li>
</ul>
<h4 id="Step4-Use-DomTreeUpdater-to-update-the-dominator-tree"><a href="#Step4-Use-DomTreeUpdater-to-update-the-dominator-tree" class="headerlink" title="Step4: Use DomTreeUpdater to update the dominator tree"></a><a target="_blank" rel="noopener" href="https://github.com/kitbarton/llvm-project/pull/4">Step4: Use DomTreeUpdater to update the dominator tree</a></h4><p>变换后的代码需要能够插入会原本的代码中进行更新。</p>
<h4 id="Step5-Use-STATISTICS-and-OpmizationRemarkEmitter-to-report-outcome"><a href="#Step5-Use-STATISTICS-and-OpmizationRemarkEmitter-to-report-outcome" class="headerlink" title="Step5: Use STATISTICS and OpmizationRemarkEmitter to report outcome"></a><a target="_blank" rel="noopener" href="https://github.com/kitbarton/llvm-project/pull/5">Step5: Use STATISTICS and OpmizationRemarkEmitter to report outcome</a></h4><ul>
<li><code>OptimizationRemarkAnalysis</code></li>
</ul>
<h3 id="Dependence-graphs"><a href="#Dependence-graphs" class="headerlink" title="Dependence graphs"></a>Dependence graphs</h3><ul>
<li>Theory:<ul>
<li>Deendence Garphs and Compiler Optimizations (1981), D.J. Kuch et al.</li>
<li>The Program Dependence Graph and Its Use in Optimizations (1987) J. Ferrante et al.</li>
</ul>
</li>
<li>Dependence graph types:<ul>
<li>Data Dependence Graph (DDG)</li>
<li>Program Dependence Graph (PDG): also consider control flow</li>
</ul>
</li>
</ul>
<h2 id="An-overview-of-LLVM"><a href="#An-overview-of-LLVM" class="headerlink" title="An overview of LLVM"></a>An overview of LLVM</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/LLVMDeveloperMeeting/2018/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/LLVMDeveloperMeeting/2018/" class="post-title-link" itemprop="url">2018</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-12-01 22:30:17 / 修改时间：22:37:48" itemprop="dateCreated datePublished" datetime="2023-12-01T22:30:17+08:00">2023-12-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://llvm.org/devmtg/2018-04/">https://llvm.org/devmtg/2018-04/</a></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/devmtg/2018-10/">https://llvm.org/devmtg/2018-10/</a></p>
<h2 id="Global-code-completion-and-architecture-of-clangd"><a href="#Global-code-completion-and-architecture-of-clangd" class="headerlink" title="Global code completion and architecture of clangd"></a>Global code completion and architecture of clangd</h2><h2 id="Porting-Function-merging-pass-to-thinlto"><a href="#Porting-Function-merging-pass-to-thinlto" class="headerlink" title="Porting Function merging pass to thinlto"></a>Porting Function merging pass to thinlto</h2><h2 id="Understanding-the-performance-of-code-using-LLVM’s-Machine-Code-Analyzer-llvm-mca"><a href="#Understanding-the-performance-of-code-using-LLVM’s-Machine-Code-Analyzer-llvm-mca" class="headerlink" title="Understanding the performance of code using LLVM’s Machine Code Analyzer (llvm-mca)"></a>Understanding the performance of code using LLVM’s Machine Code Analyzer (llvm-mca)</h2><h2 id="Implementing-an-OpenCL-compiler-for-CPU-in-LLVM"><a href="#Implementing-an-OpenCL-compiler-for-CPU-in-LLVM" class="headerlink" title="Implementing an OpenCL compiler for CPU in LLVM"></a>Implementing an OpenCL compiler for CPU in LLVM</h2><h2 id="Loop-Transformations-in-LLVM-The-Good-the-Bad-and-the-Ugly"><a href="#Loop-Transformations-in-LLVM-The-Good-the-Bad-and-the-Ugly" class="headerlink" title="Loop Transformations in LLVM: The Good, the Bad, and the Ugly"></a>Loop Transformations in LLVM: The Good, the Bad, and the Ugly</h2><h2 id="Memory-Tagging-how-it-improves-C-memory-safety-and-what-does-it-mean-for-compiler-optimizations"><a href="#Memory-Tagging-how-it-improves-C-memory-safety-and-what-does-it-mean-for-compiler-optimizations" class="headerlink" title="Memory Tagging, how it improves C++ memory safety, and what does it mean for compiler optimizations"></a>Memory Tagging, how it improves C++ memory safety, and what does it mean for compiler optimizations</h2><h2 id="Revisiting-Loop-Fusion-and-its-place-in-the-loop-transformation-framework"><a href="#Revisiting-Loop-Fusion-and-its-place-in-the-loop-transformation-framework" class="headerlink" title="Revisiting Loop Fusion, and its place in the loop transformation framework"></a>Revisiting Loop Fusion, and its place in the loop transformation framework</h2><h2 id="How-to-use-LLVM-to-optimize-your-parallel-programs"><a href="#How-to-use-LLVM-to-optimize-your-parallel-programs" class="headerlink" title="How to use LLVM to optimize your parallel programs"></a>How to use LLVM to optimize your parallel programs</h2><h2 id="LLVM-backend-development-by-example-RISC-V"><a href="#LLVM-backend-development-by-example-RISC-V" class="headerlink" title="LLVM backend development by example (RISC-V)"></a>LLVM backend development by example (RISC-V)</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/LLVMDeveloperMeeting/2016/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/LLVMDeveloperMeeting/2016/" class="post-title-link" itemprop="url">2016</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-01 22:20:31" itemprop="dateCreated datePublished" datetime="2023-12-01T22:20:31+08:00">2023-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-03 15:02:19" itemprop="dateModified" datetime="2023-12-03T15:02:19+08:00">2023-12-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://llvm.org/devmtg/2016-03/">https://llvm.org/devmtg/2016-03/</a></p>
<h2 id="New-LLD-linker-for-ELF"><a href="#New-LLD-linker-for-ELF" class="headerlink" title="New LLD linker for ELF"></a>New LLD linker for ELF</h2><h2 id="A-closer-look-at-ARM-code-size"><a href="#A-closer-look-at-ARM-code-size" class="headerlink" title="A closer look at ARM code size"></a>A closer look at ARM code size</h2><h2 id="A-journey-of-OpenCL-2-0-development-in-Clang"><a href="#A-journey-of-OpenCL-2-0-development-in-Clang" class="headerlink" title="A journey of OpenCL 2.0 development in Clang"></a>A journey of OpenCL 2.0 development in Clang</h2><p>@ARM</p>
<h2 id="C-on-Accelerators-Supporting-Single-Source-SYCL-and-HSA-Programming-Models-Using-Clang"><a href="#C-on-Accelerators-Supporting-Single-Source-SYCL-and-HSA-Programming-Models-Using-Clang" class="headerlink" title="C++ on Accelerators: Supporting Single-Source SYCL and HSA Programming Models Using Clang"></a>C++ on Accelerators: Supporting Single-Source SYCL and HSA Programming Models Using Clang</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/01/LLVMDeveloperMeeting/2015/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/01/LLVMDeveloperMeeting/2015/" class="post-title-link" itemprop="url">2015</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-01 22:16:38" itemprop="dateCreated datePublished" datetime="2023-12-01T22:16:38+08:00">2023-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-10 22:08:30" itemprop="dateModified" datetime="2023-12-10T22:08:30+08:00">2023-12-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://llvm.org/devmtg/2015-10/#tutorials">https://llvm.org/devmtg/2015-10/#tutorials</a></p>
<h2 id="Creating-an-SPMD-Vectorizer-for-OpenCL-with-LLVM"><a href="#Creating-an-SPMD-Vectorizer-for-OpenCL-with-LLVM" class="headerlink" title="Creating an SPMD Vectorizer for OpenCL with LLVM"></a>Creating an SPMD Vectorizer for OpenCL with LLVM</h2><p>@codeplay</p>
<h3 id="SPMD-execution-model"><a href="#SPMD-execution-model" class="headerlink" title="SPMD execution model"></a>SPMD execution model</h3><ul>
<li>On GPU<ul>
<li>Divide work between lanes of SIMD units (fine division)</li>
<li>SIMD execution in lockstep</li>
</ul>
</li>
<li>On CPU<ul>
<li>Divide work between cores (coarse division)</li>
<li>Sequential execution within a core</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>SIMD lane: execution of one instance of a vectorized kernel</li>
<li>SIMD width: length of parallel lanes $N$</li>
<li>Packet: Map 1 value of origin function to $N$ value, one per SIMD lane</li>
</ul>
</blockquote>
<h3 id="Vectorization"><a href="#Vectorization" class="headerlink" title="Vectorization"></a>Vectorization</h3><ul>
<li>vertical<ul>
<li>loops within a kernel</li>
</ul>
</li>
<li>horizental<ul>
<li>compute multiple work at the same time</li>
<li>does not depend on intra special code patterns</li>
<li>SPMD vectorizier</li>
</ul>
</li>
</ul>
<h4 id="Implementation-Level-IR-or-MI"><a href="#Implementation-Level-IR-or-MI" class="headerlink" title="Implementation Level: IR or MI?"></a>Implementation Level: IR or MI?</h4><p>IR更加通用，但是不能用platform-specific特性；MachineInstr则相反。</p>
<p>同时实现：在IR层进行变换，生成CFG元数据，然后利用这些数据在后端进行MI-level预测。</p>
<h3 id="Implementing-a-SPMD-vectorizer"><a href="#Implementing-a-SPMD-vectorizer" class="headerlink" title="Implementing a SPMD vectorizer"></a>Implementing a SPMD vectorizer</h3><ul>
<li>pipeline design</li>
<li>analysis<ul>
<li>Uniform value analysis (UVA)</li>
<li>Divergence analysis</li>
<li>SIDM width analysis</li>
<li>…</li>
</ul>
</li>
</ul>
<h4 id="Packetization-overview"><a href="#Packetization-overview" class="headerlink" title="Packetization overview"></a>Packetization overview</h4><p>Functionality: $F \stackrel{N}{\rightarrow}VF_N$.</p>
<ul>
<li>uniform instructions can remain scalar, executed once per work-group</li>
<li>dependso on UVA to know which instructions to vectorize</li>
</ul>
<h4 id="Scalarization-overview"><a href="#Scalarization-overview" class="headerlink" title="Scalarization overview"></a>Scalarization overview</h4><ul>
<li>eliminate vector operations from source function</li>
<li>vector types used likely to be narrower than the native SIDM width</li>
</ul>
<h4 id="Control-flow-conversion-overview"><a href="#Control-flow-conversion-overview" class="headerlink" title="Control flow conversion overview"></a>Control flow conversion overview</h4><ul>
<li>lineraizes functions that have divergent control flow: conversions from control flow to data flow</li>
<li>single program counter per SIMD group</li>
</ul>
<p>Main steps:</p>
<ul>
<li>divergence analysis</li>
<li>generate masks</li>
<li>freeze loop live variables</li>
<li>apply masks</li>
<li>convert phi nodes</li>
<li>CFG linerization</li>
</ul>
<h2 id="Polly-Optimistic-Loop-Nest-Optimizations-with-Schedule-Trees"><a href="#Polly-Optimistic-Loop-Nest-Optimizations-with-Schedule-Trees" class="headerlink" title="Polly - Optimistic Loop Nest Optimizations with Schedule Trees"></a>Polly - Optimistic Loop Nest Optimizations with Schedule Trees</h2><p>@ETH</p>
<h3 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= n; i++)</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt;= i; j++)</span><br><span class="line">    <span class="built_in">S</span>(i, j);</span><br></pre></td></tr></table></figure>

<p>$$<br>\begin{align*}<br>&amp;\mathcal{I}_S &#x3D; { S(i, j) | 0 \leq i \leq n \wedge 0 \leq j \leq i }\</p>
<p>&amp;\Theta_S &#x3D; { S(i, j) \rightarrow (i, j) }<br>\end{align*}<br>$$</p>
<p>After interchange</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= n; i++)</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt;= i; j++)</span><br><span class="line">    <span class="built_in">S</span>(j, i);</span><br></pre></td></tr></table></figure>

<p>$$<br>\begin{align*}<br>&amp;\mathcal{I}_S &#x3D; { S(i, j) | 0 \leq i \leq n \wedge 0 \leq j \leq i }\</p>
<p>&amp;\Theta_S &#x3D; { S(i, j) \rightarrow (j, i) }<br>\end{align*}<br>$$</p>
<p>The complete Polyhederal model:</p>
<ul>
<li>Iteration Space: set of all statement instances<br><br>${ S(i, j) | 0 \leq i, j \leq n }$<br><br><code>ScopStmt::getDomain()</code></li>
<li>Schedule: Execution time<br><br>${ S(i, j) \rightarrow (i, j) }$<br><br><code>ScopStmt::getSchedule()</code></li>
<li>Access Relation: Memory read&#x2F;write<br><br>${ S(i, j) \rightarrow A(i, j); S(i, j) \rightarrow A(i, j+1) }$<br><br><code>MemoryAccess::getRelation()</code></li>
</ul>
<p>通过这些数据，我们能够计算：</p>
<ul>
<li>数据依赖分析</li>
<li>访问的内存空间</li>
</ul>
<h3 id="Schedule-trees"><a href="#Schedule-trees" class="headerlink" title="Schedule trees"></a>Schedule trees</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/30/LLVMDeveloperMeeting/2017/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/30/LLVMDeveloperMeeting/2017/" class="post-title-link" itemprop="url">2017</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-11-30 21:36:47" itemprop="dateCreated datePublished" datetime="2023-11-30T21:36:47+08:00">2023-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-04 11:22:14" itemprop="dateModified" datetime="2023-12-04T11:22:14+08:00">2023-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM-Meetings/" itemprop="url" rel="index"><span itemprop="name">LLVM Meetings</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://llvm.org/devmtg/2017-03/">https://llvm.org/devmtg/2017-03/</a></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/devmtg/2017-10/">https://llvm.org/devmtg/2017-10/</a></p>
<h2 id="Introduction-to-LLVM"><a href="#Introduction-to-LLVM" class="headerlink" title="Introduction to LLVM"></a>Introduction to LLVM</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># compilation</span></span><br><span class="line">clang++ file.cpp</span><br><span class="line"><span class="comment"># generate IR</span></span><br><span class="line">clang++ -S -emit-llvm file.cpp</span><br><span class="line"><span class="comment"># run IR</span></span><br><span class="line">lli file.ll</span><br><span class="line"><span class="comment"># generate binary form .bc of IR</span></span><br><span class="line">llvm-as file.ll</span><br><span class="line"><span class="comment"># generate assembly from .bc</span></span><br><span class="line">llc file.bc</span><br><span class="line"><span class="comment"># query availible targets</span></span><br><span class="line">llc file.bc -mcpu=<span class="built_in">help</span></span><br><span class="line"><span class="comment"># opt as analysis tool</span></span><br><span class="line">opt file.ll --time-passes</span><br><span class="line"><span class="comment"># link two or more bitcode file into one file</span></span><br><span class="line">llvm-link file1.ll file2.ll -S -o output.ll</span><br></pre></td></tr></table></figure>

<h3 id="Passes-of-LLVM"><a href="#Passes-of-LLVM" class="headerlink" title="Passes of LLVM"></a>Passes of LLVM</h3><p>According to granularity:</p>
<ul>
<li>module pass</li>
<li>call graph pass</li>
<li>function pass</li>
<li>basic block pass</li>
<li>…</li>
</ul>
<p>According to functionality:</p>
<ul>
<li>analysis pass</li>
<li>transform pass</li>
</ul>
<h3 id="Writing-a-function-pass"><a href="#Writing-a-function-pass" class="headerlink" title="Writing a function pass"></a>Writing a function pass</h3><p>Source code see <a target="_blank" rel="noopener" href="https://www.mshah.io/fosdem18.html">here</a>. </p>
<p>编写的pass放在 <code>$LLVM_TOP/llvm/lib/Transforms/Hello</code> 中。因为这个目录本来就包含于LLVM中，所以一切修改完成后只要在build目录下make即可。完成后在 <code>build/lib</code> 下能找到 <code>LLVMHello.so</code>。</p>
<h4 id="Run-the-pass-with-opt"><a href="#Run-the-pass-with-opt" class="headerlink" title="Run the pass with opt"></a>Run the pass with opt</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opt -load LLVMHello.so -hello &lt; hello.bc &gt; /dev/null</span><br><span class="line">opt -load LLVMHello.so -hello &lt; hello.ll &gt; /dev/null</span><br></pre></td></tr></table></figure>

<blockquote>
<p>LLVM还能输出图片形式的CFG</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt -dot-cfg-only file.ll &gt; /dev/null</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="入手LLVM的建议"><a href="#入手LLVM的建议" class="headerlink" title="入手LLVM的建议"></a>入手LLVM的建议</h3><ol>
<li>打开doxygen文档</li>
<li><code>grep --include=&quot;*.cpp&quot; -nr &quot;getInstructions()&quot;</code> 来查询某一个函数的用法</li>
</ol>
<h3 id="Dynamic-analysis"><a href="#Dynamic-analysis" class="headerlink" title="Dynamic analysis"></a>Dynamic analysis</h3><p>Inject code to moniter or change behaviou of codes.</p>
<ol>
<li>Write hook or profiling code</li>
<li>Generate IR for hook</li>
<li>Find the code to modify</li>
<li>Time for module pass<ul>
<li>create a stub</li>
<li>iterate the module</li>
<li>make modification</li>
</ul>
</li>
</ol>
<p>这些都是基于 <code>llvm-link</code> 进行。</p>
<h2 id="Weak-Memory-Concurrency-in-C-C-11-and-LLVM"><a href="#Weak-Memory-Concurrency-in-C-C-11-and-LLVM" class="headerlink" title="Weak Memory Concurrency in C&#x2F;C++11 and LLVM"></a>Weak Memory Concurrency in C&#x2F;C++11 and LLVM</h2><h2 id="ARM-Code-Size-Optimisations"><a href="#ARM-Code-Size-Optimisations" class="headerlink" title="ARM Code Size Optimisations"></a>ARM Code Size Optimisations</h2><h2 id="SPIR-V-infrastructure-and-its-place-in-the-LLVM-ecosystem"><a href="#SPIR-V-infrastructure-and-its-place-in-the-LLVM-ecosystem" class="headerlink" title="SPIR-V infrastructure and its place in the LLVM ecosystem"></a>SPIR-V infrastructure and its place in the LLVM ecosystem</h2><p>@ARM</p>
<h3 id="SPIR-V-structure"><a href="#SPIR-V-structure" class="headerlink" title="SPIR-V structure"></a>SPIR-V structure</h3><ul>
<li>SPIR-V capabilities</li>
<li>Memory model &amp; addressing model</li>
<li>Entry point of kernels&#x2F;shaders</li>
</ul>
<h3 id="Difference-between-LLVM-and-SPIR-V"><a href="#Difference-between-LLVM-and-SPIR-V" class="headerlink" title="Difference between LLVM and SPIR-V"></a>Difference between LLVM and SPIR-V</h3><ul>
<li>Structured control flow<ul>
<li>Vulkan shaders require structure control flow</li>
<li>OpenCL requires reducible control flow</li>
<li>LLVM can produce irreducible control flow</li>
</ul>
</li>
<li>Reliance on metadata<ul>
<li>OepnCL relies on metadata to express semantics</li>
<li>SPIR-V represents those as SPIR-V opcodes</li>
</ul>
</li>
<li>Uniform control flow<ul>
<li>SPIR-V has native opcodes to represent barrier operation and cross work-group operations</li>
<li>LLVM introduce convergence function attribute to represent a similar concept</li>
</ul>
</li>
<li>Composible types</li>
</ul>
<h3 id="Tooling-NOT-official"><a href="#Tooling-NOT-official" class="headerlink" title="Tooling (NOT official)"></a>Tooling (NOT official)</h3><ul>
<li><code>spirv-opt</code></li>
<li><code>spirv-assembler</code></li>
<li><code>spirv-dis</code></li>
<li><code>spirv-val</code></li>
<li><code>spirv-cfg</code></li>
<li>SPIRV-LLVM converter</li>
</ul>
<h2 id="Bringing-link-time-optimization-to-the-embedded-world-Thin-LTO-with-Linker-Scripts"><a href="#Bringing-link-time-optimization-to-the-embedded-world-Thin-LTO-with-Linker-Scripts" class="headerlink" title="Bringing link-time optimization to the embedded world: (Thin)LTO with Linker Scripts"></a>Bringing link-time optimization to the embedded world: (Thin)LTO with Linker Scripts</h2><h2 id="lld-A-Fast-Simple-and-Portable-Linker"><a href="#lld-A-Fast-Simple-and-Portable-Linker" class="headerlink" title="lld: A Fast, Simple, and Portable Linker"></a>lld: A Fast, Simple, and Portable Linker</h2><h2 id="Writing-Great-Machine-Schedulers"><a href="#Writing-Great-Machine-Schedulers" class="headerlink" title="Writing Great Machine Schedulers"></a>Writing Great Machine Schedulers</h2><p>@ARM</p>
<h3 id="Instruction-scheduling-in-LLVM"><a href="#Instruction-scheduling-in-LLVM" class="headerlink" title="Instruction scheduling in LLVM"></a>Instruction scheduling in LLVM</h3><ul>
<li>“Legacy scheduler”: ScheduleDAGRRList<ul>
<li>Brings instruction DAG into a lineaer order of MIs</li>
</ul>
</li>
<li>“Newer”: MachineScheduler</li>
</ul>
<p>目前主要的调度都在基本块内进行；全局调度仍然是一个等待解决的问题。</p>
<h4 id="Pre-RA-Register-Allocation-scheduling"><a href="#Pre-RA-Register-Allocation-scheduling" class="headerlink" title="Pre-RA (Register Allocation) scheduling"></a>Pre-RA (Register Allocation) scheduling</h4><p>提前进行指令调度能够影响指令的活跃区间，从而减少寄存器占用，减少溢出操作。</p>
<h4 id="RA"><a href="#RA" class="headerlink" title="RA"></a>RA</h4><p>这个时候可能会引入“读后写”假依赖关系。</p>
<h4 id="Post-RA-scheduling"><a href="#Post-RA-scheduling" class="headerlink" title="Post RA scheduling"></a>Post RA scheduling</h4><p>根据资源约束、延迟进行调度。</p>
<h3 id="GenericScheduler-tryCandidate"><a href="#GenericScheduler-tryCandidate" class="headerlink" title="GenericScheduler::tryCandidate"></a><code>GenericScheduler::tryCandidate</code></h3><p>多种方式设计调度策略：</p>
<ul>
<li>Top-down</li>
<li>Bottom-up</li>
<li>Bidirectional (default)</li>
</ul>
<p><code>tryCandidate</code> 能根据启发式从中选取最好的一个策略。</p>
<ul>
<li>physical register copies</li>
<li>register pressure (excess and critical pressure)</li>
<li>acyclic latency</li>
<li>cluster</li>
<li>resgister pressure (current max)</li>
<li>latency</li>
<li>source order</li>
</ul>
<h3 id="Modelling-pipeline-for-machine-scheduler"><a href="#Modelling-pipeline-for-machine-scheduler" class="headerlink" title="Modelling pipeline for machine scheduler"></a>Modelling pipeline for machine scheduler</h3><ul>
<li><code>ScheduleDAGMI</code></li>
<li><code>Scheduler</code></li>
<li><code>TargetSchedModel</code></li>
</ul>
<p>Describe a machine model:</p>
<ul>
<li>For target:<ol>
<li>difines operand categories (<code>SchedReadWrite</code>), e.g. ARMSchedule.td</li>
<li>associates categories with actual instructions, e.g. ARMInstrInfo.td</li>
</ol>
</li>
<li>For sub-target:<ol start="3">
<li>defines description of pipeline and resources, e.g. ARMScheduleR52.td, <code>def CortexR52Model : ShcedMachineModel &#123;...&#125;</code></li>
<li>associates categories with resource and latencies, e.g. ARMScheduleR52.td, <code>def AP2UnitALU: ...</code> (resource consumed by writers), <code>def : WriteRes&lt;WriteALU, [AP2UnitALU]&gt; &#123;...&#125;</code> (associate resources and latency)</li>
</ol>
</li>
</ul>
<h4 id="TableGen-debug"><a href="#TableGen-debug" class="headerlink" title="TableGen debug"></a>TableGen debug</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">llvm-tblgen --debug-only=subtarget-emitter --print-records -I=<span class="variable">$LLVM_TOP</span>/llvm/include ...</span><br><span class="line">llc -enable-misched -debug-only=machine-scheduler</span><br></pre></td></tr></table></figure>

<h3 id="Modeling-for-more-specific-hardware-feature"><a href="#Modeling-for-more-specific-hardware-feature" class="headerlink" title="Modeling for more specific hardware feature"></a>Modeling for more specific hardware feature</h3><h4 id="Subtarget-override-of-specific-opcodes"><a href="#Subtarget-override-of-specific-opcodes" class="headerlink" title="Subtarget override of specific opcodes"></a>Subtarget override of specific opcodes</h4><ol>
<li>define a new <code>SchedWrite</code>, named attached resource</li>
<li>map list of opcodes to the <code>SchedWrite</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def PWriteSALU: SchedWriteRes&lt;[APUnitALU]&gt; &#123;</span><br><span class="line">  let Latency=4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def : InsrRW&lt;[PWriteSALU, ReadALU], instregex &quot;CLZ&quot;&gt;;</span><br></pre></td></tr></table></figure>

<h3 id="Customizing-the-MachineScheduler"><a href="#Customizing-the-MachineScheduler" class="headerlink" title="Customizing the MachineScheduler"></a>Customizing the MachineScheduler</h3><h4 id="Customize-scheduling-policy"><a href="#Customize-scheduling-policy" class="headerlink" title="Customize scheduling policy"></a>Customize scheduling policy</h4><ol>
<li>Implement <code>overrideSchedPolicy</code> in subtarget</li>
</ol>
<h4 id="Customize-MachineSchedStrategy-implementation"><a href="#Customize-MachineSchedStrategy-implementation" class="headerlink" title="Customize MachineSchedStrategy implementation"></a>Customize MachineSchedStrategy implementation</h4><ol>
<li>Implement <code>MachineSchedStrategy</code></li>
<li>Register new strategy for target <code>createMachineScheduler</code></li>
</ol>
<h4 id="DAG-mutations"><a href="#DAG-mutations" class="headerlink" title="DAG mutations"></a>DAG mutations</h4><p>These allow adding scheduling constraints:</p>
<ul>
<li>Weak edges (cluster, artificial)</li>
<li>Adjust dependence using target-specific knowledge</li>
</ul>
<ol>
<li>Implemenmt DAG mutation (<code>ScheduleDAGMutation</code>)</li>
<li>Register DAG mutation (<code>createMachineScheduler</code>)</li>
</ol>
<h2 id="Welcome-to-the-back-end-The-LLVM-machine-representation"><a href="#Welcome-to-the-back-end-The-LLVM-machine-representation" class="headerlink" title="Welcome to the back-end: The LLVM machine representation"></a>Welcome to the back-end: The LLVM machine representation</h2><p>@Apple</p>
<p>LLVM Machine IR (MIR):</p>
<ul>
<li>Machine specific instructions</li>
<li>Tasks<ul>
<li>Resource allocation</li>
<li>Lowering ABI, exception handling, debug info, …</li>
<li>Optimization: peephole, instruction&#x2F;block scheduling …</li>
</ul>
</li>
<li>Tighten constraints pass pipeline</li>
</ul>
<h3 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h3><ul>
<li>Writing an LLVM target<ul>
<li>Implement <code>TargetMachine</code> interface</li>
</ul>
</li>
<li>Code generation pipeline</li>
<li>Pass manager setup<ul>
<li><code>TargetPassConfig</code></li>
<li>Override the methods to add&#x2F;remove&#x2F;replace passes</li>
<li><code>insertPass</code> and <code>substitutePass</code> are also useful</li>
</ul>
</li>
<li>Instructions<ul>
<li><code>class MachineInstruction</code> (MI)</li>
<li>Opcode</li>
<li>Pointer to Machine Basic Block</li>
<li>Operand array</li>
<li>Debugging location</li>
</ul>
</li>
<li>Operands<ul>
<li><code>class MachineOperand</code> (MOP)</li>
<li>Register &amp; register mask</li>
<li>Immediates</li>
<li>…</li>
</ul>
</li>
<li>Opecode<ul>
<li><code>class MCInstrDesc</code></li>
<li>Flags (side effect, transformation hint, …)</li>
</ul>
</li>
<li>Basic blocks<ul>
<li><code>class MachineBasicBlock</code> (MBB)</li>
<li>Double linked list of instructions</li>
<li>Numbered</li>
<li>Arrays with predecessor&#x2F;successor blocks with execution frenquency</li>
</ul>
</li>
<li>Functions<ul>
<li><code>class MachineFunction</code> (MF)</li>
<li>Double linked list of basic blocks</li>
<li>Pointers to IR <code>Function</code>, <code>TargetMahchine</code>, <code>MCContext</code>, …</li>
<li>State <code>MachineResisterInfo</code>, <code>MachineFrameInfo</code>, <code>MachineConstantPoop</code>, <code>MachineJumpTableInfo</code></li>
</ul>
</li>
</ul>
<h3 id="Develop-tips"><a href="#Develop-tips" class="headerlink" title="Develop tips"></a>Develop tips</h3><ul>
<li><p>Produce .ll then use llc</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang -S -O1 -emit-llvm a.c -o a.ll</span><br><span class="line">llc a.ll</span><br></pre></td></tr></table></figure>
</li>
<li><p>Enable debug output</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llc -debug ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>Debug output for passes <code>foo</code> and <code>bar</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llc -debug-only=foo,bar ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>Driven with clang</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang -mllvm -debug-only=foo,bar ...</span><br><span class="line">clang -mllvm -print-machineinstrs ...</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Testing-MIR-file-format"><a href="#Testing-MIR-file-format" class="headerlink" title="Testing: MIR file format"></a>Testing: MIR file format</h3><ul>
<li><p>Stop after pass <code>isel</code> and write .mir file</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llc -stop-after=isel a.ll -o a.mir</span><br></pre></td></tr></table></figure>
</li>
<li><p>Load .mir file, run pass, write .mir file</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llc -run-pass=machine-shceduler a.mir -o a_scheduled.mir</span><br></pre></td></tr></table></figure>
</li>
<li><p>Load .mir file nad start code generation pipeline after pass <code>isel</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">llc -start-after=isel a.mir -o a.s</span><br><span class="line">llc -start-before=isel a.mir -o a.s</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>Both <code>-start-before</code> and <code>-start-after</code> often fails</p>
</blockquote>
<ul>
<li>Check a MIR whether is valid<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llc -verify-machineinstrs ...</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Register-allocation"><a href="#Register-allocation" class="headerlink" title="Register allocation"></a>Register allocation</h3><h4 id="Physical-registers"><a href="#Physical-registers" class="headerlink" title="Physical registers"></a>Physical registers</h4><ul>
<li>Defined by target <code>typedef uint16_t MCPhysReg</code></li>
<li><code>MachineRegisterInfo</code> maintains list of uses and definitions per register</li>
<li>Register classes are sets of registers</li>
<li>Register constraints modeled with classes</li>
</ul>
<h4 id="Virtual-registers"><a href="#Virtual-registers" class="headerlink" title="Virtual registers"></a>Virtual registers</h4><ul>
<li>Managed by <code>MachineRegisterInfo</code></li>
<li>Both virtual and physical registers stored in <code>unsigned</code></li>
<li><code>MachineRegisterInfo::isVirtualRegister(Reg)</code> v.s <code>MachineRegisterInfo:isPhysicalResgister(Reg)</code></li>
<li>Register &#x3D;&#x3D; 0: No register used</li>
</ul>
<h4 id="Representation-with-register-flags"><a href="#Representation-with-register-flags" class="headerlink" title="Representation with register flags"></a>Representation with register flags</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; X86 rotate left</span><br><span class="line">%EDI&lt;def,tied1&gt; = ROL32rCL %EDI&lt;kill,tied0&gt;m %EFLAGS&lt;imp-def&gt;, %CL&lt;imp-use&gt;</span><br><span class="line"></span><br><span class="line">; equal to x86 assembly</span><br><span class="line">roll %cl, %edi</span><br></pre></td></tr></table></figure>

<ul>
<li><code>imp</code>: implicite, not emitted</li>
<li><code>tied</code>: same register for Def+Use</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">; X86 XOR/Zero register</span><br><span class="line">%EAX&lt;def,tied1&gt; = XOR32rr %EAX&lt;undef, tied0&gt;, %EAX&lt;undef&gt;, %EFLAGS&lt;imp-def&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>undef</code>: register value doesn’t matter</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; X86 Set 0/1</span><br><span class="line">%vreg0&lt;def&gt; = MOV32r0 ...</span><br><span class="line">%vreg0:sub_8bit&lt;def&gt; = SETLr %EFLAGS&lt;imp-use&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>subregindex: read&#x2F;write part of a virtual register (anatomy to the relation between RAX&#x2F;EAX&#x2F;AX&#x2F;AL&#x2F;AH)</li>
</ul>
<p>Liveness indicator flags: <code>dead</code> and <code>kill</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL &lt;ga:@func&gt;, &lt;regmask %LR, %FP, %X19, %X20, ...&gt;, ...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>regmask</code>: preserves %LR, %FP, %X19, %X20, clobber every other registers</li>
</ul>
<h4 id="Liveness-tracking"><a href="#Liveness-tracking" class="headerlink" title="Liveness tracking"></a>Liveness tracking</h4><ul>
<li>Linearize program</li>
<li><code>SlotIndexes</code> maintains numbering of instructions</li>
<li>Slots per instructions</li>
</ul>
<h4 id="Register-allocation-tuning"><a href="#Register-allocation-tuning" class="headerlink" title="Register allocation tuning"></a>Register allocation tuning</h4><ul>
<li><p>XXXRegisterInfo.td: adjust allocation order</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def GR32: RegisterClass&lt;&quot;X86&quot;, [i32], 32, </span><br><span class="line">                        (add EAX, ECX, EDX, ...)&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Set register class allocation priority</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Tuple of 2 32bit registers</span><br><span class="line">def VReg_64 : RegisterClass&lt;&quot;AMDGPU&quot;, [i64], 32, (add VGPR_64)&gt; &#123;</span><br><span class="line">  let AllocationPriority = 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hinting</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class TargetRegisterInfo &#123; // ...</span><br><span class="line">  virtual void getRegAllocationHints(unsigned VirtReg,</span><br><span class="line">      ArrayRef&lt;MCPhysReg Order, SmallVectorImpl&lt;MCPhysReg&gt; &amp;Hints, /*...*/);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="Liveness-tracking-after-register-allocation"><a href="#Liveness-tracking-after-register-allocation" class="headerlink" title="Liveness tracking after register allocation"></a>Liveness tracking after register allocation</h4><ul>
<li>Use <code>LiveRegUnits</code>&#x2F;<code>LivePhysRegs</code> to compute liveness for instructions inside a block</li>
</ul>
<h4 id="Prolog-and-epilog-insertion-pass"><a href="#Prolog-and-epilog-insertion-pass" class="headerlink" title="Prolog and epilog insertion pass"></a>Prolog and epilog insertion pass</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TargetFrameLowering</span> &#123; <span class="comment">//...</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">emitPrologue</span><span class="params">(MachineFunction &amp;MF, MachineBasicBlock &amp;MBB)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">emitEpilogue</span><span class="params">(MachineFunction &amp;MF, MachineBasicBlock &amp;MBB)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">determineCalleeSaves</span><span class="params">(MachineFunction &amp;MF, BitVector &amp;SavedRegs, <span class="comment">/*...*/</span>)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">processFunctionBeforeFrameFinalized</span><span class="params">(MachineFunction &amp;MF, <span class="comment">/*...*/</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Setup call frames, setup stack frame</li>
<li>Save&#x2F;Restore callee saved registers</li>
<li>resolve frame indexes</li>
<li>register scavenging<ul>
<li>Last step of prolog epilog insertion</li>
<li>simulate liveness in basic block, allocate virtual registers</li>
<li>execute spills and reloads<br><br><code>RegScavenger::addScavengingFrameIndex(int FrameIndex)</code></li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">STRi12 %R1, &lt;fi#2&gt;, 0, ...</span><br><span class="line">            ^ frame index, currently a placeholder</span><br><span class="line">STRi12 %R1, %SP, 4104, ...</span><br><span class="line">            ^ resolved frame index</span><br><span class="line">%verg0&lt;def&gt; = ADDri %SP, 4096, ...</span><br><span class="line">STRi12 %R1, %vreg0, 8, ...</span><br><span class="line">            ^ may introduce temporary register</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/07/LLVM/Kaleidoscope/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ReRoozen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RRZ's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/07/LLVM/Kaleidoscope/" class="post-title-link" itemprop="url">Kaleidoscope</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-11-07 15:36:41" itemprop="dateCreated datePublished" datetime="2023-11-07T15:36:41+08:00">2023-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-16 21:28:04" itemprop="dateModified" datetime="2023-11-16T21:28:04+08:00">2023-11-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LLVM/" itemprop="url" rel="index"><span itemprop="name">LLVM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>出于学习和工作需要，我将从学第三节开始的Kaleidoscope教程。<br>第一节和第二节从原理上来说比较容易，但是实现起来比较繁琐，因此直接略过。</p>
<p>一份Kaleidoscope代码样例：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fib</span>(<span class="params">x</span>)</span><br><span class="line">  <span class="keyword">if</span> x &lt; <span class="number">3</span> then</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    fib(x-<span class="number">1</span>)+fib(x-<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>在Kaleidoscope中，数据类型只有double，所以 <code>ExprAST</code> 和函数的参数都没有记录类型信息。</p>
<h2 id="Code-generation-setup"><a href="#Code-generation-setup" class="headerlink" title="Code generation setup"></a>Code generation setup</h2><h3 id="相关组件"><a href="#相关组件" class="headerlink" title="相关组件"></a>相关组件</h3><p>每个表达式都能被赋给一个SSA变量，在份教程中，SSA变量以 <code>codegen</code> 方法的形式生成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ExprAST</span> &#123; </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">ExprAST</span>() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Value *<span class="title">codegen</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NumberASTExpr</span>: <span class="keyword">public</span> ExprAST &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">NumberExprAST</span>(<span class="type">double</span> Val): <span class="built_in">Val</span>(Val) &#123;&#125;</span><br><span class="line">  <span class="function">Value *<span class="title">codegen</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="type">double</span> Val;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VariableExprAST</span> : <span class="keyword">public</span> ExprAST &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">VariableExprAST</span>(<span class="type">const</span> std::string &amp;Name) : <span class="built_in">Name</span>(Name) &#123;&#125;</span><br><span class="line">  <span class="function">Value *<span class="title">codegen</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  std::string Name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BinaryExprAST</span> : <span class="keyword">public</span> ExprAST &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">BinaryExprAST</span>(<span class="type">char</span> Op, std::unique_ptr&lt;ExprAST&gt; LHS,</span><br><span class="line">                std::unique_ptr&lt;ExprAST&gt; RHS)</span><br><span class="line">      : <span class="built_in">Op</span>(Op), <span class="built_in">LHS</span>(std::<span class="built_in">move</span>(LHS)), <span class="built_in">RHS</span>(std::<span class="built_in">move</span>(RHS)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Value *<span class="title">codegen</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="type">char</span> Op;</span><br><span class="line">  std::unique_ptr&lt;ExprAST&gt; LHS, RHS;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CallExprAST</span> : <span class="keyword">public</span> ExprAST &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">CallExprAST</span>(<span class="type">const</span> std::string &amp;Callee,</span><br><span class="line">              std::vector&lt;std::unique_ptr&lt;ExprAST&gt;&gt; Args)</span><br><span class="line">      : <span class="built_in">Callee</span>(Callee), <span class="built_in">Args</span>(std::<span class="built_in">move</span>(Args)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Value *<span class="title">codegen</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  std::string Callee;</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;ExprAST&gt;&gt; Args;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Q1：为什么SSA变量都是以裸指针的形式返回，而 <code>ExprAST</code> 都是以智能指针返回？</p>
</blockquote>
<p>接下来需要准备一些必要的数据结构，方便起见，它们都被声明为全局变量。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/ADT/APFloat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/ADT/STLExtras.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/BasicBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Constants.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/DerivedTypes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IRBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LLVMContext.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Module.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Type.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Verifier.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> std::unique_ptr&lt;LLVMContext&gt; TheContext;</span><br><span class="line"><span class="type">static</span> std::unique_ptr&lt;IRBuilder&lt;&gt;&gt; <span class="built_in">Builder</span>(TheContext);</span><br><span class="line"><span class="type">static</span> std::unique_ptr&lt;Module&gt; TheModule;</span><br><span class="line"><span class="type">static</span> std::map&lt;std::string, Value *&gt; NamedValues;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>LLVMContext</code> 中包含了LLVM的一些核心数据结构，如类型信息和符号表</li>
<li><code>IRBuilder</code> 能够追踪IR文件&#x2F;<code>Module</code> 的位置信息，并能够插入新的指令</li>
<li><code>Module</code> 是LLVM IR的顶级结构，保存了解析文件中所有的IR</li>
<li><code>NamedValues</code> 需要追踪当前作用域中的定义的变量，记录代表它们的LLVM IR value</li>
</ul>
<blockquote>
<p>A1：在上面的数据结构中，除了 <code>NameValues</code> 会保存 <code>Value</code> 指针，<code>Module</code> 保存IR时也会隐式地保存 <code>Value</code> 指针，所以应该使用裸指针作为返回值。</p>
</blockquote>
<h3 id="表达式的生成"><a href="#表达式的生成" class="headerlink" title="表达式的生成"></a>表达式的生成</h3><h4 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Value *<span class="title">NumberExprAST::codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ConstantFP::<span class="built_in">get</span>(*TheContext, <span class="built_in">APFloat</span>(Val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ConstantFP</code> 是LLVM IR的数字常量，具体的值保存在 <code>APFloat</code> 的内部。<br>因为在LLVM IR中所有的常量都使用一份资源，所以API使用的风格是 <code>foo::get(...)</code><br>而不是 <code>new foo(...)</code> 或者 <code>foo::Create(...)</code>。<br><code>APFloat</code> 含义为Arbitrary Precision Float，类似的数据结构都定义在<br><code>$LLVM_TOP/llvm/include/llvm/ADT</code> 目录中。<br>使用正确的数据结构非常重要，这将会决定生成代码的内存开销和性能，内容可以参考<a target="_blank" rel="noopener" href="https://www.llvm.org/docs/ProgrammersManual.html#picking-the-right-data-structure-for-a-task%E3%80%82">https://www.llvm.org/docs/ProgrammersManual.html#picking-the-right-data-structure-for-a-task。</a></p>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Value *<span class="title">VariableExprAST::codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Value *V = NamedValues[Name];</span><br><span class="line">  <span class="keyword">if</span> (!V)</span><br><span class="line">    <span class="built_in">LogErrorV</span>(<span class="string">&quot;Unknown variable name&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> V;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我们假设变量的IR已经生成，其值已经生成并保存在 <code>NamedValues</code> 中。<br>不过因为Kaleidoscope的简单性，只有函数的参数才会被保存在 <code>NamedValues</code> 中。<br>不过在后面的章节中，还有循环索引的循环本地变量会被加入。</p>
<h4 id="二元表达式"><a href="#二元表达式" class="headerlink" title="二元表达式"></a>二元表达式</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Value *<span class="title">BinaryExprAST::codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Value *L = LHS-&gt;<span class="built_in">codegen</span>();</span><br><span class="line">  Value *R = RHS-&gt;<span class="built_in">codegen</span>();</span><br><span class="line">  <span class="keyword">if</span> (!L || !R)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (Op) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">    <span class="keyword">return</span> Builder-&gt;<span class="built_in">CreateFAdd</span>(L, R, <span class="string">&quot;addtmp&quot;</span>);</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">    <span class="keyword">return</span> Builder-&gt;<span class="built_in">CreateFSub</span>(L, R, <span class="string">&quot;subtmp&quot;</span>);</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">    <span class="keyword">return</span> Builder-&gt;<span class="built_in">CreateFMul</span>(L, R, <span class="string">&quot;multmp&quot;</span>);</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;&lt;&#x27;</span>:</span><br><span class="line">    L = Builder-&gt;<span class="built_in">CreateFCmpULT</span>(L, R, <span class="string">&quot;cmptmp&quot;</span>);</span><br><span class="line">    <span class="comment">// Convert bool 0/1 to double 0.0 or 1.0</span></span><br><span class="line">    <span class="keyword">return</span> Builder-&gt;<span class="built_in">CreateUIToFP</span>(L, Type::<span class="built_in">getDoubleTy</span>(*TheContext),</span><br><span class="line">                                 <span class="string">&quot;booltmp&quot;</span>);</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">LogErrorV</span>(<span class="string">&quot;invalid binary operator&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们递归地生成了代码，但是 <code>Builder</code> 会为我们自动追踪代码的位置，因此我们只需要决定<br>生成的代码的类型和操作数。<br>如果我们生成了多个 <code>addtmp</code> 类型表达式，LLVM会自动添加数字后缀来保持命名的唯一性。</p>
<p>LLVM的 <code>fcmp</code> 指令的结果会保存在一个1位整型中。<br>但是Kaleidoscope中只有浮点数，所以我们希望结果是0.0或者1.0，因此使用了 <code>uitofp</code> 转换类型 (使用 <code>sitofp</code> 会生成0.0和-0.1)。</p>
<h4 id="函数-调用表达式"><a href="#函数-调用表达式" class="headerlink" title="(函数) 调用表达式"></a>(函数) 调用表达式</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Value *<span class="title">CallExprAST::codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Look up the name in the global module table.</span></span><br><span class="line">  Function *CalleeF = TheModule-&gt;<span class="built_in">getFunction</span>(Callee);</span><br><span class="line">  <span class="keyword">if</span> (!CalleeF) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">LogErrorV</span>(<span class="string">&quot;Unknown function referenced&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If argument mismatch error.</span></span><br><span class="line">  <span class="keyword">if</span> (CalleeF-&gt;<span class="built_in">arg_size</span>() != Args.<span class="built_in">size</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">LogErrorV</span>(<span class="string">&quot;Incorrect # arguments passed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;Value *&gt; ArgsV;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>, e = Args.<span class="built_in">size</span>(); i != e; ++i) &#123;</span><br><span class="line">    ArgsV.<span class="built_in">push_back</span>(Args[i]-&gt;<span class="built_in">codegen</span>());</span><br><span class="line">    <span class="keyword">if</span> (!ArgsV.<span class="built_in">back</span>()) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Builder-&gt;<span class="built_in">CreateCall</span>(CalleeF, ArgsV, <span class="string">&quot;calltmp&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>调用函数的第一步肯定是查表。<br>Kaleidoscope并不能动态地创建函数，所以只能从全局的符号表中进行查找。<br>因为LLVM与C语言的调用规范一致，所以标准库中的函数，如 <code>sin</code> 能够被直接调用。</p>
<h4 id="扩展现有的表达式…"><a href="#扩展现有的表达式…" class="headerlink" title="扩展现有的表达式…"></a>扩展现有的表达式…</h4><p>将LLVM IR作为一门语言学习，学习里面的数据结构能够将Kaleidoscope扩展。<br>教程网址：<a target="_blank" rel="noopener" href="https://llvm.org/docs/LangRef.html">https://llvm.org/docs/LangRef.html</a></p>
<h3 id="函数的生成"><a href="#函数的生成" class="headerlink" title="函数的生成"></a>函数的生成</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrototypeAST</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">PrototypeAST</span>(<span class="type">const</span> std::string &amp;Name, std::vector&lt;std::string&gt; Args)</span><br><span class="line">      : <span class="built_in">Name</span>(Name), <span class="built_in">Args</span>(std::<span class="built_in">move</span>(Args)) &#123;&#125;</span><br><span class="line">  <span class="function">Function *<span class="title">codegen</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">const</span> std::string &amp;<span class="title">getName</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> Name; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  std::string Name;</span><br><span class="line">  std::vector&lt;std::string&gt; Args;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FunctionAST</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">FunctionAST</span>(std::unique_ptr&lt;PrototypeAST&gt; Proto,</span><br><span class="line">              std::unique_ptr&lt;ExprAST&gt; Body)</span><br><span class="line">      : <span class="built_in">Proto</span>(std::<span class="built_in">move</span>(Proto)), <span class="built_in">Body</span>(std::<span class="built_in">move</span>(Body)) &#123;&#125;</span><br><span class="line">  <span class="function">Function *<span class="title">codegen</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  std::unique_ptr&lt;PrototypeAST&gt; Proto;</span><br><span class="line">  std::unique_ptr&lt;ExprAST&gt; Body;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>函数原型和函数定义是区别于表达式 <code>ExprAST</code> 的另一类AST类型。<br>并且 <code>codegen</code> 方法的实现上相较于表达式更加复杂</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Function *<span class="title">PrototypeAST::codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Make the function type: double (*func)(double, double) etc.</span></span><br><span class="line">  <span class="function">std::vector&lt;Type *&gt; <span class="title">Doubles</span><span class="params">(Args.size(), </span></span></span><br><span class="line"><span class="params"><span class="function">                              Type::getDoubleTy(*TheContext))</span></span>;</span><br><span class="line">  FunctionType *FT = </span><br><span class="line">    FunctionType::<span class="built_in">get</span>(Type::<span class="built_in">getDoubleTy</span>(*TheContext), Doubles, <span class="literal">false</span>);</span><br><span class="line">  </span><br><span class="line">  Function *F = </span><br><span class="line">    Function::<span class="built_in">Create</span>(FT, Function::ExternalLinkage, Name, TheModule.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set names for all arguments.</span></span><br><span class="line">  <span class="type">unsigned</span> Idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;Arg: F-&gt;<span class="built_in">args</span>()) &#123;</span><br><span class="line">    Arg.<span class="built_in">setName</span>(Args[Idx++]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在LLVM IR中，所有的Type都是唯一的，所以获得一个类型信息都是用 <code>get</code> 方法。</p>
</blockquote>
<p>在创建LLVM IR的Function对象时，<code>ExternalLinkage</code> 表示函数的定义可能出现在当前<br>Module之外的地方。<br><code>TheModule</code> 是一个Module指针，传入Module本体将这个函数名注册在符号表中。<br>为参数设置变量名并不必要，但是这样做带来的好处是使得LLVM IR也能有可读性。</p>
<blockquote>
<p>Q2：这里只是构造了一个函数原型，为什么返回的却是一个完整的 <code>Function *</code> 呢？</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Function *<span class="title">FunctionAST::codegen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// First, check for an existing function from a previous &#x27;extern&#x27; declaration.</span></span><br><span class="line">  Function *TheFunction = TheModule-&gt;<span class="built_in">getFunction</span>(Proto-&gt;<span class="built_in">getName</span>());</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!TheFunction) TheFunction = Proto-&gt;<span class="built_in">codegen</span>();</span><br><span class="line">  <span class="keyword">if</span> (!TheFunction) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (!TheFunction-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> (Function *)<span class="built_in">LogErrorV</span>(<span class="string">&quot;Function cannot be redefined.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a new basic block to start insertion into.</span></span><br><span class="line">  BasicBlock *BB = BasicBlock::<span class="built_in">Create</span>(*TheContext, <span class="string">&quot;entry&quot;</span>, TheFunction);</span><br><span class="line">  Builder-&gt;<span class="built_in">SetInsertPointer</span>(BB);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Record the function arguments in the NamedValues map.</span></span><br><span class="line">  NamedValues.<span class="built_in">clear</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;Arg: TheFunction-&gt;<span class="built_in">args</span>()) &#123;</span><br><span class="line">    NamedValues[std::<span class="built_in">string</span>(Arg.<span class="built_in">getName</span>())] = &amp;Arg;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Value *RetVal = Body-&gt;<span class="built_in">codegen</span>()) &#123;</span><br><span class="line">    <span class="comment">// Finish off the function.</span></span><br><span class="line">    Builder-&gt;<span class="built_in">CreateRet</span>(RetVal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate the generated code, checking for consistency.</span></span><br><span class="line">    <span class="built_in">verifyFunction</span>(*TheFunction);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> TheFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前函数体只有一个计算返回值的表达式，直接用 <code>Builder</code> 创建一个ret语句即可，<br>且只要一个基本块就足够了。<br><code>verifyFunction</code> 相当于对LLVM IR进行了一次静态检查。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ReRoozen</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ReRoozen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
